---
title: "TT_GreatLakesFish"
author: "Jeff Grayum"
date: "6/9/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading libraries
```{r}
library(tidyverse)
library(tidytuesdayR)
library(scales)
library(ggthemes)
```

Loading datasets.
```{r}
tt <- tuesdata <- tidytuesdayR::tt_load('2021-06-08')

fishing <- tt$fishing %>%
  filter(values >= 0) %>%
  mutate(species = str_replace(str_to_title(species), "([^s])s$", "\\1")) 
  

stocked <- tt$stocked

stocked %>%
  view()
```


```{r}
fishing %>%
  filter(!is.na(grand_total), 
         lake == "Erie") %>%
  mutate(species = fct_lump(species, 6)) %>%
  filter(species != "Other",
         year > 1920) %>%
  group_by(year, lake, species) %>%
  summarize(yr_sp_total = sum(grand_total)) %>%
  ggplot(aes(year, yr_sp_total, fill = species)) +
  geom_col() +
  facet_wrap(~ species, scales = "free_y") +
  scale_y_continuous(labels = comma) +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Total catch",
       title = "Yearly species totals caught in Lake Erie",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        legend.position = "none")

fishing %>%
  count(lake, sort = TRUE)


fishing %>%
  filter(!is.na(grand_total), 
         lake == "Superior") %>%
  mutate(species = fct_lump(species, 6)) %>%
  filter(species != "Other",
         year > 1920) %>%
  group_by(year, species) %>%
  summarize(yr_sp_total = sum(grand_total)) %>%
  ggplot(aes(year, yr_sp_total, fill = species)) +
  geom_col() +
  facet_wrap(~ species, scales = "free_y") +
  scale_y_continuous(labels = comma) +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Total catch",
       title = "Yearly species totals caught in Lake Superior",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        legend.position = "none")

fishing %>%
  filter(!is.na(grand_total), 
         lake == "Huron") %>%
  mutate(species = fct_lump(species, 6)) %>%
  filter(species != "Other",
         year > 1920) %>%
  group_by(year, species) %>%
  summarize(yr_sp_total = sum(grand_total)) %>%
  ggplot(aes(year, yr_sp_total, fill = species)) +
  geom_col() +
  facet_wrap(~ species, scales = "free_y") +
  scale_y_continuous(labels = comma) +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Total catch",
       title = "Yearly species totals caught in Lake Huron",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        legend.position = "none")
```

Now for David's stuff.
```{r}
fishing %>%
  ggplot(aes(grand_total)) +
  geom_histogram()

fishing %>%
  ggplot(aes(grand_total + 1)) +
  geom_histogram() +
  scale_x_log10(labels = comma) +
  theme_fivethirtyeight() +
  labs(x = "Grand total (log scale + 1)",
       y = "Count",
       title = "Histogram: Grand totals") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  ggplot(aes(values + 1)) +
  geom_histogram() +
  scale_x_log10(labels = comma) +
  theme_fivethirtyeight() +
  labs(x = "Value (log scale + 1)",
       y = "Count",
       title = "Histogram: Values") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  count(lake)

fishing %>%
  count(species, sort = TRUE)

fishing %>%
  group_by(year, lake, species) %>%
  summarize(total_values = sum(values, na.rm = TRUE),
            first_grand_total = min(grand_total, na.rm = TRUE),
            n_grand_total = n_distinct(grand_total)) %>%
  filter(year >= 2000) %>%
  ungroup() %>%
  count(n_grand_total)
```


```{r}
fishing %>%
  group_by(year) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(year, total_fish)) +
  geom_line() +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Total fish",
       title = "Total fish caught each year in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

#Let's make ourselves a quick function
summarize_fishing <- function(tbl) {
  tbl %>%
    summarize(n_obs = n(),
              total_fish = sum(values, na.rm = TRUE)) %>%
    arrange(desc(total_fish))
}

fishing %>%
  group_by(year) %>%
  summarize_fishing() %>%
  ggplot(aes(year, total_fish)) +
  geom_line() +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Total fish",
       title = "Total fish caught each year in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  group_by(decade = 10 * year %/% 10) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(decade, total_fish)) +
  geom_col() +
  theme_fivethirtyeight() +
  scale_y_continuous(labels = comma_format()) +
  labs(x = "Decade",
       y = "Total fish",
       title = "Total fish caught each year in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  group_by(species) %>%
  summarize_fishing()

fishing %>%
  mutate(species = fct_lump(species, 6, w = values),
         species = fct_reorder(species, values, sum)) %>%
  group_by(decade = 10 * year %/% 10,
           species) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(decade, total_fish, fill = species)) +
  geom_col() +
  theme_fivethirtyeight() +
  scale_y_continuous(labels = comma_format()) +
  labs(x = "Decade",
       y = "Total fish",
       title = "Total fish caught each year in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  mutate(species = fct_lump(species, 5, w = values),
         species = fct_reorder(species, values, sum)) %>%
  group_by(decade = 10 * year %/% 10,
           species) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(decade, total_fish, fill = species)) +
  geom_col() +
  theme_fivethirtyeight() +
  facet_wrap(~species) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = "Decade",
       y = "Total fish",
       title = "Total fish caught each year in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

fishing %>%
  mutate(species = fct_lump(species, 15, w = values),
         species = fct_reorder(species, -values, sum)) %>%
  group_by(decade = 10 * year %/% 10,
           species) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(decade, total_fish, fill = species)) +
  geom_area() +
  theme_fivethirtyeight() +
  facet_wrap(~species) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = "Decade",
       y = "Total fish",
       title = "Yearly fish production in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        legend.position = "none")


#Oh boy we gotta do some cleaning!
fishing %>%
  filter(str_detect(species, "Cisco")) %>%
  mutate(species = fct_lump(species, 8, w = values),
         species = fct_reorder(species, -values, sum)) %>%
  group_by(decade = 10 * year %/% 10,
           species) %>%
  summarize(total_fish = sum(values, na.rm = TRUE)) %>%
  ggplot(aes(decade, total_fish, fill = species)) +
  geom_area() +
  theme_fivethirtyeight() +
  facet_wrap(~species) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = "Decade",
       y = "Total fish",
       title = "Yearly fish production in the Great Lakes",
       caption = "Source: Great Lakes Fishery Commission") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        legend.position = "none")

fishing %>%
  group_by(species, year) %>%
  summarize_fishing() %>%
  summarize(total_fish = sum(total_fish),
            peak_year = year[which.max(total_fish)]) %>%
  arrange(desc(total_fish)) %>%
  head(16) %>%
  mutate(species = fct_reorder(species, peak_year)) %>%
  ggplot(aes(peak_year, species)) +
  geom_point(aes(size = total_fish)) +
  theme_fivethirtyeight() +
  scale_size_continuous(labels = comma_format()) +
  labs(x = "Year of peak prodcution",
       y = "Species",
       title = "Peak year of production for Great Lake's fish",
       caption = "Source: Great Lakes Fishery Commission",
       size = "Total catch") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"))

```


```{r}
fishing %>%
  mutate(lake = fct_reorder(lake, values, sum, .desc = TRUE)) %>%
  group_by(decade = 10 * year %/% 10,
           lake) %>%
  summarize_fishing() %>%
  ggplot(aes(decade, total_fish, fill = lake)) +
  geom_area() +
  scale_y_continuous(labels = comma_format()) +
  facet_wrap(~ lake) +
  theme_fivethirtyeight() +
  theme(legend.position = "none",
        axis.title = element_text(),
        text = element_text(family = "Times New Roman")) +
  labs(x = "Decade",
       y = "Total production per decade (thousands of pounds)",
       title = "Production across the Great Lakes over time")

by_lake_species <- fishing %>%
  filter(lake != "Saint Clair") %>%
  mutate(species = fct_lump(species, 15, w = values),
         species = fct_reorder(species, values, sum),
         lake = fct_reorder(lake, values, sum, .desc = TRUE)) %>% 
  group_by(lake, species) %>%
  summarize_fishing() 

by_lake_species %>%
  ggplot(aes(lake, species, fill = total_fish)) +
  geom_tile() +
  scale_fill_gradient2(low = "white", high = "darkblue", labels = comma) +
  theme(panel.grid = element_blank(),
        axis.title = element_text(),
        text = element_text(family = "Times New Roman")) +
  expand_limits(fill = 0) +
  labs(x = "Lake",
       y = "Species",
       fill = "All time production") 

#Next we're going to normalize our data.
by_lake_species %>%
  group_by(lake) %>%
  mutate(pct = total_fish / sum(total_fish)) %>%
  ggplot(aes(lake, species, fill = pct)) +
  geom_tile() +
  scale_fill_gradient2(low = "white", high = "darkblue", labels = percent_format(accuracy = 1)) +
  theme(panel.grid = element_blank(),
        axis.title = element_text(),
        text = element_text(family = "Times New Roman")) +
  expand_limits(fill = 0) +
  labs(x = "Lake",
       y = "Species",
       fill = "All time production") 
```

Let's look at our other dataset.
```{r}
stocked <- stocked %>%
  janitor::clean_names()

stocked %>%
  count(site, sort = TRUE)

stocked %>%
  count(st_site, sort = TRUE)

stocked %>%
  count(species, sort = TRUE)

stocked %>%
  ggplot(aes(year)) +
  geom_histogram(binwidth = 1) +
  theme_fivethirtyeight() +
  labs(x = "Year",
       y = "Count",
       title = "Yearly distribution") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        panel.grid.major = element_blank()) +
  scale_y_continuous(labels = comma)

stocked %>%
  ggplot(aes(length)) +
  geom_histogram(bins = 200) +
theme_fivethirtyeight() +
  labs(x = "Length (log scale)",
       y = "Count",
       title = "Length distribution") +
  theme(axis.title = element_text(),
        text = element_text(family = "Times New Roman"),
        panel.grid.major = element_blank()) +
  scale_y_continuous(labels = comma) +
  scale_x_log10(labels = comma)

stocked %>%
  group_by(species) %>%
  summarize(median_length = median(length, na.rm = TRUE ))
```

YALL WANNA DO SOME FORECASTING
```{r}

```

